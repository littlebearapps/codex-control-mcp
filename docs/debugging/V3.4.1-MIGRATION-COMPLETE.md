# v3.4.1 Config Directory Migration - Complete

**Date**: 2025-11-17
**Status**: ✅ Code Complete - Ready for Testing
**Version**: 3.4.1

---

## Summary

Successfully implemented automatic config directory migration from `codex-control` to `mcp-delegator` for naming consistency.

---

## Changes Made

### Code Changes (src/)

1. **`src/state/task_registry.ts`** (lines 91-125)
   - Added automatic migration logic in constructor
   - Detects old directory and renames to new directory
   - Fallback to old directory if migration fails
   - Warnings if both directories exist

2. **`src/tools/list_environments.ts`** (lines 5, 25)
   - Updated config path: `~/.config/codex-control/` → `~/.config/mcp-delegator/`
   - Updated tool description with new path

3. **`src/state/cloud_task_registry.ts`** (lines 42-46)
   - Updated config path: `~/.config/codex-control/` → `~/.config/mcp-delegator/`
   - Added note about migration handled by TaskRegistry

4. **`src/tools/github_setup.ts`** (lines 380, 382)
   - Updated MCP resource reference: `codex-control` → `mcp-delegator`
   - Updated GitHub repo URL

### Version Updates

All version numbers updated to **3.4.1**:

- ✅ `package.json` (line 3)
- ✅ `src/index.ts` (line 45)
- ✅ `config.json` (line 4)
- ✅ `CLAUDE.md` (3 occurrences)

### Documentation

1. **`CHANGELOG.md`**
   - Added v3.4.1 release notes
   - Documented BREAKING CHANGE with migration details
   - Included manual migration commands
   - Provided verification steps

2. **`docs/debugging/CONFIG-MIGRATION-PLAN.md`**
   - Updated all v3.5.0 references to v3.4.1

---

## Migration Behavior

### Scenario 1: Old Directory Only (Most Users)

```bash
# Before migration
~/.config/codex-control/
├── tasks.db (5.2 MB)
├── environments.json
└── cloud-tasks.json

# First run of v3.4.1
[TaskRegistry] Migrating config from codex-control to mcp-delegator...
[TaskRegistry] ✅ Migration complete! Config now at: ~/.config/mcp-delegator

# After migration
~/.config/mcp-delegator/
├── tasks.db (5.2 MB)        ← Moved
├── environments.json        ← Moved
└── cloud-tasks.json         ← Moved
```

**Result**: ✅ Automatic migration, no user action needed

### Scenario 2: New Directory Only (New Users)

```bash
# No old directory exists
# First run of v3.4.1 creates:
~/.config/mcp-delegator/
└── tasks.db (new, empty)
```

**Result**: ✅ Clean install in new location

### Scenario 3: Both Directories Exist (Edge Case)

```bash
# Both exist (unusual but possible)
~/.config/codex-control/      ← Old
~/.config/mcp-delegator/      ← New

# First run of v3.4.1
[TaskRegistry] ⚠️  Both config directories exist. Using new directory: ~/.config/mcp-delegator
[TaskRegistry] Old directory still present: ~/.config/codex-control
[TaskRegistry] You can manually remove the old directory if migration is complete.
```

**Result**: ⚠️ Uses new directory, warns about old

### Scenario 4: Migration Fails (Permissions Issue)

```bash
# Old directory exists but can't be renamed (e.g., permissions issue)
# First run of v3.4.1
[TaskRegistry] ⚠️  Migration failed: Error: EACCES: permission denied
[TaskRegistry] Falling back to old directory for safety
```

**Result**: ⚠️ Falls back to old directory, still works

---

## Testing Plan

### Test 1: Normal Migration (Primary Scenario)

```bash
# 1. Ensure clean state
rm -rf ~/.config/mcp-delegator

# 2. Verify old directory exists
ls -la ~/.config/codex-control/

# 3. Build and link new version
npm run build
npm link

# 4. Test migration (use any MCP tool to trigger registry initialization)
# Example: Use cleanup_registry tool via Claude Code MCP

# 5. Verify migration occurred
ls -la ~/.config/mcp-delegator/  # Should contain all files
ls -la ~/.config/codex-control/  # Should not exist

# 6. Verify task history preserved
sqlite3 ~/.config/mcp-delegator/tasks.db "SELECT COUNT(*) FROM tasks;"
# Should show 60 tasks (your current count)
```

**Expected**:

- ✅ Old directory renamed to new directory
- ✅ All files preserved (tasks.db, environments.json, cloud-tasks.json)
- ✅ Task history intact (60 tasks)
- ✅ No data loss

### Test 2: Fresh Install

```bash
# 1. Remove both directories
rm -rf ~/.config/codex-control ~/.config/mcp-delegator

# 2. Use MCP tool (triggers registry initialization)

# 3. Verify new directory created
ls -la ~/.config/mcp-delegator/

# 4. Verify database initialized
sqlite3 ~/.config/mcp-delegator/tasks.db ".schema"
```

**Expected**:

- ✅ New directory created
- ✅ Empty tasks.db created
- ✅ Schema correct

### Test 3: Both Directories Exist

```bash
# 1. Create both directories
mkdir -p ~/.config/codex-control ~/.config/mcp-delegator
echo '{"test":"old"}' > ~/.config/codex-control/test.json
echo '{"test":"new"}' > ~/.config/mcp-delegator/test.json

# 2. Use MCP tool

# 3. Verify warning logged (check MCP server stderr)
# 4. Verify new directory used
```

**Expected**:

- ✅ Warning logged
- ✅ New directory used
- ✅ Old directory untouched

---

## Verification Commands

### After Migration

```bash
# 1. Check new directory exists
ls -la ~/.config/mcp-delegator/

# Expected output:
# tasks.db
# environments.json
# cloud-tasks.json (if you have cloud tasks)

# 2. Verify task count preserved
sqlite3 ~/.config/mcp-delegator/tasks.db "SELECT COUNT(*) FROM tasks;"
# Expected: 60 (your current count)

# 3. Verify environments preserved
cat ~/.config/mcp-delegator/environments.json | jq .
# Expected: Your Codex Cloud environments

# 4. Check old directory removed
ls -la ~/.config/codex-control/
# Expected: "No such file or directory"

# 5. Verify MCP server version
mcp-delegator --version
# Expected: 3.4.1 (after npm link or npm publish)
```

---

## Rollback Plan

If migration causes issues:

### Immediate Rollback (Before Publishing)

```bash
# 1. Rename directory back
mv ~/.config/mcp-delegator ~/.config/codex-control

# 2. Unlink new version
npm unlink -g @littlebearapps/mcp-delegator

# 3. Install old version
npm install -g @littlebearapps/mcp-delegator@3.3.2
```

### After Publishing (if users report issues)

```bash
# Users can manually revert:
mv ~/.config/mcp-delegator ~/.config/codex-control
npm install -g @littlebearapps/mcp-delegator@3.3.2
```

---

## Build Verification

✅ **Build Status**: SUCCESS

```
> @littlebearapps/mcp-delegator@3.4.1 build
> tsc

(no errors)
```

✅ **TypeScript Compilation**: PASSED
✅ **All Version Numbers**: UPDATED (3.4.1)
✅ **CHANGELOG**: UPDATED
✅ **Migration Logic**: IMPLEMENTED

---

## Next Steps

### Option 1: Test Locally (Recommended)

```bash
# 1. Link for local testing
npm link

# 2. Test migration scenarios (see Testing Plan above)

# 3. If successful, proceed with publishing
```

### Option 2: Publish Directly (if confident)

```bash
# 1. Commit changes
git add -A
git commit -m "feat: migrate config directory from codex-control to mcp-delegator

BREAKING CHANGE: Config directory renamed for naming consistency
- Old: ~/.config/codex-control/
- New: ~/.config/mcp-delegator/
- Automatic migration on first run
- Fallback to old directory if migration fails
"

# 2. Push to main
git push origin main

# 3. semantic-release will automatically:
# - Publish to npm as v3.4.1
# - Create GitHub release
# - Update CHANGELOG (already done manually)
```

---

## Files Changed

### Source Code (4 files)

- `src/state/task_registry.ts` (migration logic)
- `src/tools/list_environments.ts` (path update)
- `src/state/cloud_task_registry.ts` (path update)
- `src/tools/github_setup.ts` (doc updates)

### Version Files (4 files)

- `package.json`
- `src/index.ts`
- `config.json`
- `CLAUDE.md`

### Documentation (2 files)

- `CHANGELOG.md`
- `docs/debugging/CONFIG-MIGRATION-PLAN.md`

**Total**: 10 files changed

---

## Success Criteria

- [x] Code compiles without errors
- [x] All version numbers updated to 3.4.1
- [x] CHANGELOG updated with migration notice
- [x] Migration logic handles all scenarios
- [x] Fallback to old directory if migration fails
- [ ] **TESTING REQUIRED**: Migration works on Nathan's machine
- [ ] **TESTING REQUIRED**: Task history preserved (60 tasks)
- [ ] npm package published to v3.4.1
- [ ] User communication posted

---

## User Impact

**Existing Users**:

- ✅ Automatic migration on first run
- ✅ No action required
- ✅ All data preserved
- ⚠️ One-time warning in logs (migration message)

**New Users**:

- ✅ Clean install in correct directory
- ✅ No migration needed

**Breaking Change**:

- Config directory path changes
- Automatic migration handles this
- Manual migration available if needed

---

**Status**: ✅ Code Complete - Ready for Testing
**Recommendation**: Test migration locally before publishing
**Blocker**: None - ready to proceed with testing

---

**Next Action**: Run Test 1 (Normal Migration) to verify migration works correctly
